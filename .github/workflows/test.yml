# Helm Chart Testing Workflow
# Mock testing for Helm charts before publishing

name: Helm Chart Tests

on:
  pull_request:
    paths:
      - 'Microsoft/azure-ai-services/charts/**'
      - 'OpenSources/**'
  push:
    branches:
      - main
    # paths:
    #   - 'Microsoft/azure-ai-services/charts/**'
    #   - 'OpenSources/**'

permissions:
  contents: read

jobs:
  lint-content-safety:
    name: Lint Content Safety
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.14.0

      - name: Lint chart
        id: lint
        run: |
          echo "=== Linting chart: Microsoft/azure-ai-services/charts/content-safety ==="
          mkdir -p lint-reports
          helm lint Microsoft/azure-ai-services/charts/content-safety 2>&1 | tee lint-reports/content-safety.log
          echo "exit_code=$?" >> $GITHUB_OUTPUT

      - name: Upload lint report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: lint-report-content-safety
          path: lint-reports/

  lint-document-intelligence:
    name: Lint Document Intelligence
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.14.0

      - name: Lint chart
        id: lint
        run: |
          echo "=== Linting chart: Microsoft/azure-ai-services/charts/document-intelligence ==="
          mkdir -p lint-reports
          helm lint Microsoft/azure-ai-services/charts/document-intelligence 2>&1 | tee lint-reports/document-intelligence.log
          echo "exit_code=$?" >> $GITHUB_OUTPUT

      - name: Upload lint report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: lint-report-document-intelligence
          path: lint-reports/

  lint-magentic-ui:
    name: Lint Magentic UI
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.14.0

      - name: Lint chart
        id: lint
        run: |
          echo "=== Linting chart: OpenSources/magentic-ui ==="
          mkdir -p lint-reports
          helm lint OpenSources/magentic-ui 2>&1 | tee lint-reports/magentic-ui.log
          echo "exit_code=$?" >> $GITHUB_OUTPUT

      - name: Upload lint report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: lint-report-magentic-ui
          path: lint-reports/

  lint-summary:
    name: Lint Summary
    runs-on: ubuntu-latest
    needs: [lint-content-safety, lint-document-intelligence, lint-magentic-ui]
    if: always()
    steps:
      - name: Download all lint reports
        uses: actions/download-artifact@v4
        with:
          path: lint-reports

      - name: Generate lint summary
        run: |
          echo "# Helm Lint Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Lint Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          for chart in content-safety document-intelligence magentic-ui; do
            report=$(find lint-reports -name "${chart}.log" 2>/dev/null | head -1)
            if [ -f "$report" ]; then
              echo "### $chart" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              cat "$report" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            fi
          done

      - name: Check overall status
        run: |
          echo "All chart linting completed. Check summary for details."

  template-charts:
    name: Template Charts
    runs-on: ubuntu-latest
    needs: [lint-content-safety, lint-document-intelligence, lint-magentic-ui]
    strategy:
      fail-fast: false
      matrix:
        chart:
          - path: Microsoft/azure-ai-services/charts/content-safety
          - path: Microsoft/azure-ai-services/charts/document-intelligence
          - path: OpenSources/magentic-ui
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.14.0

      - name: Template chart
        run: |
          helm template test-release ${{ matrix.chart.path }} --debug

  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: [lint-content-safety, lint-document-intelligence, lint-magentic-ui]
    strategy:
      fail-fast: false
      matrix:
        chart:
          - path: Microsoft/azure-ai-services/charts/content-safety
          - path: Microsoft/azure-ai-services/charts/document-intelligence
          - path: OpenSources/magentic-ui
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.14.0

      - name: Build chart dependencies
        run: |
          helm dependency update ${{ matrix.chart.path }} || echo "No dependencies found"

      - name: Template chart for testing (dry-run)
        run: |
          echo "=== Template chart: ${{ matrix.chart.path }} ==="
          helm template test-release ${{ matrix.chart.path }} --debug

      - name: Install chart dry-run
        run: |
          echo "=== Install chart dry-run: ${{ matrix.chart.path }} ==="
          helm install test-release ${{ matrix.chart.path }} --dry-run --debug

  full-install-test:
    name: Full Install Test - document-intelligence
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    needs: [lint-content-safety, lint-document-intelligence, lint-magentic-ui, template-charts, unit-tests]
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.14.0

      - name: Build chart dependencies
        run: |
          helm dependency update Microsoft/azure-ai-services/charts/document-intelligence || echo "No dependencies found"

      - name: Install chart with default values (dry-run)
        id: install-dryrun
        run: |
          echo "=== Install chart dry-run: default values ==="
          helm install doc-intel Microsoft/azure-ai-services/charts/document-intelligence \
            --dry-run --debug || {
            echo "::error::Helm install dry-run failed"
            exit 1
          }
        continue-on-error: true

      - name: Template chart with default values
        id: template-default
        run: |
          echo "=== Template chart: default values ==="
          helm template doc-intel Microsoft/azure-ai-services/charts/document-intelligence \
            --debug > template-default.yaml || {
            echo "::error::Helm template failed"
            exit 1
          }
        continue-on-error: true

      - name: Upgrade chart with modified values (dry-run)
        id: upgrade-dryrun
        run: |
          cat <<EOF > test-values.yaml
          replicaCount: 2
          documentIntelligence:
            modelType: layout
            advanced:
              storageTimeToLiveInMinutes: 1440
              taskMaxRunningTimeSpanInMinutes: 60
              healthCheckMemoryUpperboundInMB: 8192
              logging:
                consoleLogLevel: Debug
          EOF
          echo "=== Upgrade chart dry-run: modified values ==="
          helm upgrade doc-intel Microsoft/azure-ai-services/charts/document-intelligence \
            --values test-values.yaml --dry-run --debug || {
            echo "::error::Helm upgrade dry-run failed"
            exit 1
          }
        continue-on-error: true

      - name: Template chart with modified values
        id: template-upgrade
        run: |
          cat <<EOF > test-values.yaml
          replicaCount: 2
          documentIntelligence:
            modelType: layout
            advanced:
              storageTimeToLiveInMinutes: 1440
              taskMaxRunningTimeSpanInMinutes: 60
              healthCheckMemoryUpperboundInMB: 8192
              logging:
                consoleLogLevel: Debug
          EOF
          echo "=== Template chart: modified values ==="
          helm template doc-intel Microsoft/azure-ai-services/charts/document-intelligence \
            --values test-values.yaml --debug > template-upgrade.yaml || {
            echo "::error::Helm template with values failed"
            exit 1
          }
        continue-on-error: true

      - name: Test Results Summary
        if: always()
        run: |
          echo "==========================================" >> $GITHUB_STEP_SUMMARY
          echo "HELM DRY-RUN TEST RESULTS SUMMARY" >> $GITHUB_STEP_SUMMARY
          echo "==========================================" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.install-dryrun.outcome }}" == "success" ]; then
            echo "✅ Install dry-run: PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Install dry-run: FAILED" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.template-default.outcome }}" == "success" ]; then
            echo "✅ Template default: PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Template default: FAILED" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.upgrade-dryrun.outcome }}" == "success" ]; then
            echo "✅ Upgrade dry-run: PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Upgrade dry-run: FAILED" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.template-upgrade.outcome }}" == "success" ]; then
            echo "✅ Template with values: PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Template with values: FAILED" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "==========================================" >> $GITHUB_STEP_SUMMARY
          cat $GITHUB_STEP_SUMMARY
